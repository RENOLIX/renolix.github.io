<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RENOLIX - Suivi Chantier</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
body {margin:0;font-family:'Montserrat',sans-serif;background:#fff;color:#222;padding-bottom:calc(88px + env(safe-area-inset-bottom));}
header {display:flex;align-items:center;justify-content:space-between;padding:5px 20px;height:60px;position:fixed;width:100%;top:0;z-index:1000;background:rgba(255,255,255,0.95);box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.logo-container {display:flex;align-items:center;}
.logo-container img{width:50px;height:auto;}
.header-center {position: absolute; left: 46%; letter-spacing: 2px; transform: translateX(-50%); text-align: center;}
.header-center h1 {margin:0;font-size:28.5px;font-family:'Playfair Display', serif;font-weight:700;background: linear-gradient(-45deg,#000 20%,#d4af37 50%,#000 80%);background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation: luxuryShine 2.2s linear infinite;}
@keyframes luxuryShine {0% {background-position:200% 0;}100% {background-position:-200% 0;}}
.menu { display:flex; align-items:center; padding-right:25px; }
header nav { display:flex; gap:15px; align-items:center; }
header nav a { color:#222; text-decoration:none; font-weight:500; transition:.3s; }
header nav a:hover { color:#d4af37; }
.connexion-btn { display:inline-block; background:linear-gradient(90deg,#d4af37,#b8860b); color:#fff !important; font-weight:bold; padding:8px 18px; border-radius:20px; text-decoration:none; margin-top:10px; transition:0.3s; text-align:center; }
.connexion-btn:hover { box-shadow:0 0 15px #d4af37; }
.menu-toggle { display:none; flex-direction:column; cursor:pointer; padding:8px; margin-right:10px; }
.menu-toggle div { width:25px; height:3px; background:#222; margin:4px 0; transition:0.3s; }
@media(max-width:768px){
  header nav { position:absolute; top:60px; right:10px; width:220px; flex-direction:column; display:none; padding:15px 20px; background: rgba(255,255,255,0.3); backdrop-filter: blur(12px); border: 2px solid #d4af37; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.25); z-index: 1050; transition: all 0.4s ease; }
  header nav.active {display:flex; flex-direction:column;}
  header nav a { margin:5px 0; padding:10px 15px; font-weight: 600; color:#222; text-transform: uppercase; letter-spacing: 1px; border-radius: 10px; transition: all 0.3s ease; }
  header nav a:hover { background: linear-gradient(90deg,#d4af37,#ffd700); color:#fff; box-shadow: 0 0 10px #ffd700, 0 0 20px #d4af37; }
  .menu-toggle {display:flex;}
}
section { padding:100px 10px 40px; }
h2 { color:#d4af37; text-align:center; margin-bottom:25px; }
#suivi-container { max-width:900px; margin:0 auto; display:flex; flex-direction:column; gap:20px; }
#photo-upload { display:flex; flex-direction:column; gap:10px; }
#photo-upload input, #photo-upload select, #photo-upload button { padding:10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
#photo-upload button { background:linear-gradient(90deg,#d4af37,#ffd700); color:#fff; font-weight:bold; cursor:pointer; border:none; transition:.3s; }
#photo-upload button:hover { box-shadow:0 0 12px #ffd700; }
.photo-card { display:flex; flex-direction:column; gap:5px; padding:10px; border:1px solid #d4af37; border-radius:12px; background:#faf7ef; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.photo-card img { width:100%; border-radius:10px; object-fit:cover; }
.photo-meta { font-size:12px; color:#555; text-align:right; }
</style>
</head>
<body>

<header>
  <div class="logo-container"><img src="https://i.postimg.cc/hjNvjvcc/Logo-Cosm-tiques-Minimaliste-Luxe-Noir-Blanc-Dor-20250711-192039-0000.png" alt="Logo Renolix"></div>
  <div class="header-center"><a href="index.html"><h1>RENOLIX</h1></a></div>
  <div class="menu">
    <nav id="nav-links">
      <a href="index.html">Accueil</a>
      <a href="devis-gratuit.html">Devis Gratuit</a>
      <a href="à-propos.html">À propos</a>
      <a href="contact.html">Contact</a>
      <a href="login.html" id="navAuthLink" class="connexion-btn" data-mode="login">Connexion</a>
    </nav>
    <div class="menu-toggle" onclick="toggleMenu()"><div></div><div></div><div></div></div>
  </div>
</header>

<section>
  <h2>Suivi du Chantier</h2>
  <div id="suivi-container">
    <div id="photo-upload" class="hidden">
      <select id="client-select">
        <option value="">Sélectionner un client</option>
      </select>
      <input type="file" id="photo-input" accept="image/*" />
      <button id="upload-btn">Envoyer la photo</button>
    </div>
    <div id="photos-list"></div>
  </div>
</section>

<footer>
  <p>&copy; 2025 RENOLIX. Tous droits réservés.</p>
  <p>
    <a href="https://www.instagram.com/renolix.dz?igsh=M3JsZXd0NTJjY3d6" target="_blank">Instagram</a> |
    <a href="https://www.facebook.com/share/1724QHzM9r/" target="_blank">Facebook</a> |
    <a href="https://wa.me/213542093648" target="_blank">WhatsApp</a>
  </p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', async function(){
  const { createClient } = supabase;
  const supabaseUrl = "https://kawlncpapaxdzjyhnhhz.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imthd2xuY3BhcGF4ZHpqeWhuaGh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NjkwMjEsImV4cCI6MjA3MjQ0NTAyMX0.jm-6Ll26WU-y0EMCBMR7Zv_aX7XU3iPomuMZNofps2U";
  const sb = createClient(supabaseUrl, supabaseKey);

  const photoUploadDiv = document.getElementById('photo-upload');
  const clientSelect = document.getElementById('client-select');
  const photoInput = document.getElementById('photo-input');
  const uploadBtn = document.getElementById('upload-btn');
  const photosList = document.getElementById('photos-list');

  // 1️⃣ Vérifier l'utilisateur et rôle
  const { data: { user } } = await sb.auth.getUser();
  if(!user) { alert('Connectez-vous pour voir cette page'); location.href='login.html'; return; }

  // Récupérer rôle: artisan ou client
  const { data: profile } = await sb.from('profiles').select('*').eq('id', user.id).single();
  const role = profile?.role || 'client';
  if(role==='artisan'){ photoUploadDiv.classList.remove('hidden'); }

  // 2️⃣ Récupérer liste clients pour l'artisan
  if(role==='artisan'){
    const { data: clients } = await sb.from('profiles').select('id,email').eq('role','client');
    clients.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.email;
      clientSelect.appendChild(opt);
    });
  }

  // 3️⃣ Upload photo
  uploadBtn.addEventListener('click', async ()=>{
    const file = photoInput.files[0];
    const clientId = clientSelect.value;
    if(!file || !clientId){ alert('Sélectionner un client et une photo'); return; }

    const fileName = `${Date.now()}_${file.name}`;
    const { data, error } = await sb.storage.from('suivi-chantier').upload(fileName, file);
    if(error){ console.error(error); alert('Erreur upload'); return; }

    // Ajouter en table "photos" pour le client
    const photoUrl = sb.storage.from('suivi-chantier').getPublicUrl(fileName).data.publicUrl;
    const { error: insertErr } = await sb.from('photos').insert([{ artisan_id: user.id, client_id: clientId, url: photoUrl, created_at: new Date().toISOString() }]);
    if(insertErr){ console.error(insertErr); alert('Erreur ajout base'); return; }

    photoInput.value='';
    alert('Photo envoyée avec succès');
    loadPhotos(clientId); // Recharger photos
  });

  // 4️⃣ Fonction pour afficher photos
  async function loadPhotos(clientId=null){
    let query = sb.from('photos').select('*').order('created_at', { ascending: false });
    if(role==='client'){ query = query.eq('client_id', user.id); }
    else if(clientId){ query = query.eq('client_id', clientId); }
    const { data: photos, error } = await query;
    if(error){ console.error(error); return; }
    photosList.innerHTML='';
    photos.forEach(p=>{
      const div = document.createElement('div');
      div.className='photo-card';
      div.innerHTML = `<img src="${p.url}" alt="Photo chantier"><div class="photo-meta">${new Date(p.created_at).toLocaleString()}</div>`;
      photosList.appendChild(div);
    });
  }

  // Load photos initial
  loadPhotos();
});
</script>
</body>
</html>