<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RENOLIX - Suivi du chantier</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<style>
/* === STYLES (inchangés sauf petits fix) === */
:root{ --gold:#d4af37; --gold-dark:#b8860b; --text:#222; --muted:#555; --bg:#fff; --shadow:0 10px 25px rgba(0,0,0,0.12); }
*{box-sizing:border-box}
body{margin:0;font-family:'Montserrat',sans-serif;background:var(--bg);color:var(--text);padding-bottom:84px}
header{display:flex;align-items:center;justify-content:space-between;padding:5px 20px;height:60px;position:fixed;width:100%;top:0;left:0;z-index:1000;background:rgba(255,255,255,0.97);box-shadow:0 2px 10px rgba(0,0,0,0.08);backdrop-filter:saturate(120%) blur(6px)}
.logo-container img{width:50px}
.header-center{position:absolute;left:50%;transform:translateX(-50%);text-align:center}
.header-center h1{margin:0;font-size:24px;font-family:'Playfair Display',serif;font-weight:700;letter-spacing:1px;background:linear-gradient(-45deg,#000 20%,var(--gold) 50%,#000 80%);background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:luxuryShine 2.2s linear infinite}
@keyframes luxuryShine{0%{background-position:200% 0}100%{background-position:-200% 0}}
.connexion-btn{background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:#fff!important;padding:8px 16px;border-radius:20px;text-decoration:none;font-weight:700}
.suivi-wrap{display:grid;grid-template-columns:340px 1fr;gap:24px;margin-top:80px;padding:40px 10%}
@media(max-width:980px){.suivi-wrap{grid-template-columns:1fr}}
.card{background:#fff;border:2px solid var(--gold);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
.card h3{margin:0 0 12px;color:var(--gold-dark)}
.badge{padding:4px 8px;border-radius:999px;border:1px solid var(--gold);font-size:12px}
.feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.card-photo{border:1px solid #ddd;border-radius:14px;overflow:hidden;background:#fff}
.card-photo img{width:100%;height:200px;object-fit:cover}
.meta{padding:8px;font-size:12px;color:#555}
.feed-empty{padding:20px;text-align:center;color:#777;border:1px dashed #ddd;border-radius:12px}
.dropzone{border:2px dashed var(--gold);border-radius:14px;padding:16px;text-align:center;background:#fffdf4}
.thumb-list{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.thumb{width:90px;height:90px;overflow:hidden;border-radius:10px}
.thumb img{width:100%;height:100%;object-fit:cover}
.btn{padding:8px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
.btn.gold{background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:#fff}
.btn.ghost{background:#fff;border:2px solid var(--gold);color:var(--gold-dark)}
footer{background:#f9f9f9;text-align:center;padding:20px;margin-top:40px;font-size:14px}
</style>
</head>
<body>

<header>
  <div class="logo-container"><img src="https://i.postimg.cc/hjNvjvcc/Logo-Cosm-tiques-Minimaliste-Luxe-Noir-Blanc-Dor-20250711-192039-0000.png" alt="Logo"></div>
  <div class="header-center"><h1>RENOLIX</h1></div>
  <a href="login.html" id="navAuthLink" class="connexion-btn">Connexion</a>
</header>

<section>
  <h2>Suivi du chantier <span class="badge" id="roleBadge">...</span></h2>
  <div class="suivi-wrap">
    <!-- Panneau ARTISAN -->
    <aside class="card" id="artisanPanel" style="display:none;">
      <h3>Envoyer des photos</h3>
      <div id="dropzone" class="dropzone">
        <p>Glissez-déposez vos images ou <button id="pickBtn" class="btn ghost" type="button">Parcourir</button></p>
        <input id="fileInput" type="file" accept="image/*" multiple style="display:none;">
        <div class="thumb-list" id="thumbList"></div>
      </div>
      <div style="margin-top:10px;text-align:right">
        <button id="sendBtn" class="btn gold">Envoyer</button>
      </div>
      <div id="statusMsg" style="font-size:12px;color:#777;margin-top:6px"></div>
    </aside>

    <!-- Flux CLIENT -->
    <main>
      <div class="card">
        <div id="feedEmpty" class="feed-empty">Aucune photo pour le moment.</div>
        <div id="feed" class="feed"></div>
      </div>
    </main>
  </div>
</section>

<footer>&copy; 2025 RENOLIX. Tous droits réservés.</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const { createClient } = supabase;
  const supabaseUrl = "https://kawlncpapaxdzjyhnhhz.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
  const sb = createClient(supabaseUrl, supabaseKey);

  const roleBadge = document.getElementById("roleBadge");
  const artisanPanel = document.getElementById("artisanPanel");
  const feed = document.getElementById("feed");
  const feedEmpty = document.getElementById("feedEmpty");
  const fileInput = document.getElementById("fileInput");
  const pickBtn = document.getElementById("pickBtn");
  const sendBtn = document.getElementById("sendBtn");
  const thumbList = document.getElementById("thumbList");
  const statusMsg = document.getElementById("statusMsg");

  let currentUser = null;
  let currentRole = null;
  let selectedFiles = [];

  // === Auth ===
  const { data: { user } } = await sb.auth.getUser();
  if (!user) {
    roleBadge.textContent = "Non connecté";
    return;
  }
  currentUser = user;

  // Récupérer rôle dans la table Users
  const { data: udata } = await sb.from("Users").select("role").eq("id", user.id).single();
  currentRole = udata?.role || "client";
  roleBadge.textContent = currentRole;

  if (currentRole === "artisan") {
    artisanPanel.style.display = "block";
  }

  // === Upload ===
  pickBtn.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", (e) => {
    selectedFiles = [...e.target.files];
    thumbList.innerHTML = "";
    selectedFiles.forEach(f => {
      const div = document.createElement("div");
      div.className = "thumb";
      const img = document.createElement("img");
      img.src = URL.createObjectURL(f);
      div.appendChild(img);
      thumbList.appendChild(div);
    });
  });

  sendBtn.addEventListener("click", async () => {
    if (!selectedFiles.length) return;
    statusMsg.textContent = "Envoi en cours...";
    for (const file of selectedFiles) {
      const path = `${Date.now()}-${file.name}`;
      const { error: uploadError } = await sb.storage.from("chantier_photo").upload(path, file);
      if (uploadError) { console.error(uploadError); continue; }
      const { data: { publicUrl } } = sb.storage.from("chantier_photo").getPublicUrl(path);
      await sb.from("Photos").insert({
        Client_id: currentUser.id,
        Artisan_id: currentUser.id,
        Url: publicUrl,
        role: currentRole
      });
    }
    statusMsg.textContent = "Photos envoyées ✅";
    selectedFiles = [];
    thumbList.innerHTML = "";
    loadFeed();
  });

  // === Feed ===
  async function loadFeed() {
    const { data: photos } = await sb.from("Photos").select("*").order("created_at", { ascending: false });
    feed.innerHTML = "";
    if (!photos || !photos.length) {
      feedEmpty.style.display = "block";
      return;
    }
    feedEmpty.style.display = "none";
    photos.forEach(p => {
      const card = document.createElement("div");
      card.className = "card-photo";
      card.innerHTML = `
        <img src="${p.Url}" alt="">
        <div class="meta">${new Date(p.created_at).toLocaleString()}</div>
      `;
      feed.appendChild(card);
    });
  }
  loadFeed();
});
</script>

<!-- === Bottom Nav RENOLIX - Thème Gris Foncé Pro, Devis uniforme, Profil dynamique === -->
<style>
  :root{
    --bg-nav:#f5f5f5;         
    --text:#333;               
    --accent:#333;             
    --glow:rgba(0,0,0,0.15);   
  }

  body {
    padding-bottom: calc(68px + env(safe-area-inset-bottom));
    margin:0;
    font-family: 'Montserrat', sans-serif;
  }

  .bottom-nav{
    position:fixed;
    left:0; right:0;
    bottom:0;
    width:100%;
    height:68px;
    display:grid; 
    grid-template-columns:repeat(4,1fr);
    background:var(--bg-nav); 
    box-shadow: 0 -6px 20px var(--glow), 0 0 12px rgba(0,0,0,0.05);
    border-radius:16px 16px 0 0;
    z-index:1100;
  }

  .bn-item{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:4px;
    text-decoration:none; 
    color:var(--text); 
    font-weight:600; 
    font-size:12px; 
    letter-spacing:.2px;
    transition: transform 0.2s ease, color 0.2s ease, filter 0.2s ease;
    position:relative;
  }

  .bn-item:active{
    transform: scale(0.92) translateY(2px);
  }

  .bn-icon svg{
    width:22px; height:22px; 
    fill:var(--text); 
    transition: transform .2s ease, fill .2s ease, filter .2s ease;
  }

  .bn-item:hover .bn-icon svg{
    transform:translateY(-2px);
    filter:drop-shadow(0 0 6px rgba(0,0,0,0.15));
  }

  .bn-item.active .bn-icon svg,
  .bn-item.active .bn-label{
    color:var(--accent);
    fill:var(--accent);
    text-shadow: 0 0 6px rgba(0,0,0,0.1);
  }

  @media (prefers-reduced-motion: reduce){
    .bn-item,.bn-icon svg{ transition:none !important; }
  }
</style>

<nav class="bottom-nav" role="navigation" aria-label="Navigation inférieure">
  <a href="index.html" class="bn-item" data-route="index.html" aria-label="Accueil">
    <span class="bn-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M12 3 3 11v8a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-4h2v4a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-8Z"/></svg>
    </span>
    <span class="bn-label">Accueil</span>
  </a>

  <a href="suivi-chantier.html" class="bn-item" data-route="suivi-chantier.html" data-auth="required" aria-label="Suivi du chantier">
    <span class="bn-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M9 7h10v2H9zM9 11h10v2H9zM9 15h10v2H9zM7.5 6 6 7.5 4.5 6 3 7.5 6 10.5 9 7.5z"/></svg>
    </span>
    <span class="bn-label">Suivi</span>
  </a>

  <a href="devis-gratuit.html" class="bn-item" data-route="devis-gratuit.html" aria-label="Demander un devis">
    <span class="bn-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path fill="currentColor" d="M14 2v6h6"/><path d="M8 12h6M8 16h8"/></svg>
    </span>
    <span class="bn-label">Devis</span>
  </a>

  <!-- Initialement Se connecter (après login => Profil) -->
  <a href="login.html" class="bn-item" id="bn-profile" data-route="profil.html" data-auth="required" aria-label="Profil">
    <span class="bn-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z"/><path d="M4 20a8 8 0 0 1 16 0v1H4Z"/></svg>
    </span>
    <span class="bn-label" id="bn-profile-label">Se connecter</span>
  </a>
</nav>

<script>
  // Détecte si l'utilisateur est connecté (à adapter à ton système)
  const isLoggedIn = localStorage.getItem('loggedIn') === 'true';

  const profileBtn = document.getElementById('bn-profile');
  const profileLabel = document.getElementById('bn-profile-label');

  if(isLoggedIn){
    profileLabel.textContent = 'Profil';
    profileBtn.href = 'profil.html';
  } else {
    profileLabel.textContent = 'Se connecter';
    profileBtn.href = 'login.html';
  }
</script>
<!-- === /Bottom Nav RENOLIX === -->

</body>
</html>